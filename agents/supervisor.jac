"""
Code Genius Supervisor - Orchestrates the entire analysis pipeline (Fixed for Asynchronous operation)
"""

import os;
import from datetime {datetime};
# Assume imports for agents and utils are correct at the top of the file

# ==================== CODE GENIUS SUPERVISOR ====================

walker CodeGeniusSupervisor {
ย ย """
ย ย Main orchestrator walker that coordinates all agents in the pipeline.
ย ย It updates the Repository node status as it progresses.
ย ย """
ย ย # FIX: Use repo_id passed from main.jac
ย ย has repo_id: str;
ย ย has repo_url: str;
ย ย ย 
ย ย has output_dir: str = "./outputs";
ย ย has max_size_mb: int = 500;
ย ย has max_files: int = 100;
ย ย has include_diagrams: bool = True;
ย ย has cleanup_workspace: bool = True;
ย ย 
ย ย # Pipeline state
ย ย has current_stage: str = "initialized";
ย ย has workspace_path: str = "";
ย ย 
ย ย # No report necessary on finish, the graph is the source of truth
ย ย can orchestrate with `root entry {
ย ย ย ย 
ย ย ย ย # 1. Find the Repository Node to update
ย ย ย ย repo = here.get_node(self.repo_id);
ย ย ย ย if not repo {
ย ย ย ย ย ย print(f"โ SUPERVISOR ERROR: Cannot find Repository node with ID {self.repo_id}");
ย ย ย ย ย ย disengage;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย print(f"๐ฏ SUPERVISOR: Starting pipeline for {repo.name}");
ย ย ย ย 
ย ย ย ย # Update status to indicate job is running
ย ย ย ย repo.status = "analyzing";
ย ย ย ย 
ย ย ย ย # STAGE 1: Repository Mapping
ย ย ย ย self.current_stage = "mapping";
ย ย ย ย print(f"๐ STAGE 1/3: Repository Mapping\n");
ย ย ย ย repo.status = "mapping"; # Update status for user visibility
ย ย ย ย mapping_success = self.execute_repo_mapping(repo);
ย ย ย ย 
ย ย ย ย if not mapping_success {
ย ย ย ย ย ย repo.status = "failed";
ย ย ย ย ย ย disengage;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย # STAGE 2: Code Analysis
ย ย ย ย self.current_stage = "analyzing";
ย ย ย ย print(f"\n๐ STAGE 2/3: Code Analysis\n");
ย ย ย ย repo.status = "analyzing"; # Update status for user visibility
ย ย ย ย analysis_success = self.execute_code_analysis(repo); # Pass repo node
ย ย ย ย 
ย ย ย ย if not analysis_success {
ย ย ย ย ย ย repo.status = "failed";
ย ย ย ย ย ย disengage;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย # STAGE 3: Documentation Generation
ย ย ย ย self.current_stage = "documenting";
ย ย ย ย print(f"\n๐ STAGE 3/3: Documentation Generation\n");
ย ย ย ย repo.status = "documenting"; # Update status for user visibility
ย ย ย ย doc_success = self.execute_documentation(repo); # Pass repo node
ย ย ย ย 
ย ย ย ย if not doc_success {
ย ย ย ย ย ย repo.status = "failed";
ย ย ย ย ย ย disengage;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย # Pipeline completed successfully
ย ย ย ย repo.status = "completed";
ย ย ย ย self.current_stage = "completed";

ย ย ย ย # Cleanup if requested
ย ย ย ย if self.cleanup_workspace and self.workspace_path {
ย ย ย ย ย ย print(f"\n๐งน Cleaning up workspace: {self.workspace_path}");
ย ย ย ย ย ย FileSystemHelper.cleanup_workspace(self.workspace_path);
ย ย ย ย }
ย ย ย ย 
ย ย ย ย print("\nโ PIPELINE COMPLETED SUCCESSFULLY\n");
ย ย }
ย ย 
ย ย """Execute repository mapping stage"""
ย ย # FIX: Removed Python type hint `-> bool`
ย ย can execute_repo_mapping(repo_node) {
ย ย ย ย """Run RepoMapper agent"""
ย ย ย ย try {
ย ย ย ย ย ย mapper = RepoMapper(
ย ย ย ย ย ย ย ย repo_url=self.repo_url,
ย ย ย ย ย ย ย ย max_size_mb=self.max_size_mb
ย ย ย ย ย ย );
ย ย ย ย ย ย 
ย ย ย ย ย ย # Spawn mapper on the Repository node
ย ย ย ย ย ย result = repo_node spawn mapper;
ย ย ย ย ย ย 
ย ย ย ย ย ย # Store workspace path for cleanup
ย ย ย ย ย ย if mapper.workspace_dir {
ย ย ย ย ย ย ย ย self.workspace_path = mapper.workspace_dir;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย # Check result - FIX: mapper.result will be a dict from mapper.report
ย ย ย ย ย ย if result["success"] {
ย ย ย ย ย ย ย ย print(f"โ Stage 1 Complete: Repository mapped successfully");
ย ย ย ย ย ย ย ย # Update total files count on the repo node
ย ย ย ย ย ย ย ย repo_node.total_files = result.get("total_files", 0);
ย ย ย ย ย ย ย ย return True;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย print(f"โ Stage 1 Failed: {result.get('error')}");
ย ย ย ย ย ย ย ย repo_node.error_message = result.get("error", "Unknown mapping error");
ย ย ย ย ย ย ย ย return False;
ย ย ย ย ย ย }
ย ย ย ย } except Exception as e {
ย ย ย ย ย ย print(f"โ Stage 1 Error: {e}");
ย ย ย ย ย ย repo_node.error_message = str(e);
ย ย ย ย ย ย return False;
ย ย ย ย }
ย ย }
ย ย 
ย ย """Execute code analysis stage"""
ย ย # FIX: Removed Python type hint `-> bool`
ย ย can execute_code_analysis(repo_node) {
ย ย ย ย """Run CodeAnalyzer agent"""
ย ย ย ย try {
ย ย ย ย ย ย # CodeAnalyzer should traverse from the repo_node passed to it
ย ย ย ย ย ย analyzer = CodeAnalyzer(
ย ย ย ย ย ย ย ย max_files_to_analyze=self.max_files
ย ย ย ย ย ย );
ย ย ย ย ย ย 
ย ย ย ย ย ย result = repo_node spawn analyzer;
ย ย ย ย ย ย 
ย ย ย ย ย ย # Check result
ย ย ย ย ย ย if result["success"] {
ย ย ย ย ย ย ย ย analyzed_count = result.get("analyzed_count", 0);
ย ย ย ย ย ย ย ย print(f"โ Stage 2 Complete: Analyzed {analyzed_count} files");
ย ย ย ย ย ย ย ย # Update the Repository node with analysis progress
ย ย ย ย ย ย ย ย repo_node.analyzed_files = analyzed_count;
ย ย ย ย ย ย ย ย return True;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย print(f"โ Stage 2 Failed");
ย ย ย ย ย ย ย ย repo_node.error_message = "Code analysis failed";
ย ย ย ย ย ย ย ย return False;
ย ย ย ย ย ย }
ย ย ย ย } except Exception as e {
ย ย ย ย ย ย print(f"โ Stage 2 Error: {e}");
ย ย ย ย ย ย repo_node.error_message = str(e);
ย ย ย ย ย ย return False;
ย ย ย ย }
ย ย }
ย ย 
ย ย """Execute documentation generation stage"""
ย ย # FIX: Removed Python type hint `-> bool`
ย ย can execute_documentation(repo_node) {
ย ย ย ย """Run DocGenie agent"""
ย ย ย ย try {
ย ย ย ย ย ย doc_gen = DocGenie(
ย ย ย ย ย ย ย ย output_dir=self.output_dir,
ย ย ย ย ย ย ย ย include_diagrams=self.include_diagrams
ย ย ย ย ย ย );
ย ย ย ย ย ย 
ย ย ย ย ย ย result = repo_node spawn doc_gen;
ย ย ย ย ย ย 
ย ย ย ย ย ย # Check result
ย ย ย ย ย ย if result["success"] {
ย ย ย ย ย ย ย ย print(f"โ Stage 3 Complete: Documentation saved");
ย ย ย ย ย ย ย ย return True;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย print(f"โ Stage 3 Failed");
ย ย ย ย ย ย ย ย repo_node.error_message = "Documentation generation failed";
ย ย ย ย ย ย ย ย return False;
ย ย ย ย ย ย }
ย ย ย ย } catch Exception as e {
ย ย ย ย ย ย print(f"โ Stage 3 Error: {e}");
ย ย ย ย ย ย repo_node.error_message = str(e);
ย ย ย ย ย ย return False;
ย ย ย ย }
ย ย }
}